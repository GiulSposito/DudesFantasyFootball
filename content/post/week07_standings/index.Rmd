---
title: '[Week 07] League Standings'
author: "Giuliano Sposito"
date: '2019-10-23'
description: ''
displayInList: yes
displayInMenu: no
dropCap: yes
draft: no
resources:
- name: featuredImage
  params:
    description: 49ers Splash Defense!
  src: 49ers_splash.jpg
slug: rank-week-7
tags:
- playoffs
- rank
- points
- wins and losses
categories:
- ranking
params:
  week: 7
---

<!--more-->

## League Ranking

![Rank](/img/rank_week7.jpg)

## Week Trophies

![Trophies](/img/trophies_week7.jpg)

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
# put rnotbook in the same workdir
knitr::opts_knit$set(root.dir = normalizePath(rprojroot::find_rstudio_root_file())) 
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r loadAndDataHandling}
# libs
library(tidyverse)
library(ggimage)
library(knitr)
library(glue)
library(kableExtra)
  
# parameter
curr.week <- params$week

# game results
matchups <- readRDS("./data/post_matchups_results.rds")

# para cada time do roster tira informacoes de ponto, se ganhou e qual o rank
extractTeam <- . %>% 
  select(id, team=name, logoUrl, pts, outcome) %>% 
  mutate(
    id = as.integer(id),
    win=(outcome=="win"),
    loss=(outcome!="win"),
    pts=as.numeric(pts)
  ) %>% 
  as_tibble()

# adiciona informacoes do oponente para fazer o ranking H2H
addOpponent <- function(.t, .o){ 
  .t %>% 
    mutate(
      pts.ctr = .o$pts,
      op.id   = .o$id,
      op.team = .o$team,
      op.out  = .o$outcome
    ) %>% 
    return()
}

# para cada jogo dentro da semana
# processa os times
extractGame <- function(.game) {
  
  .teams <- .game[[1]]$matchup 
  
  at <- extractTeam(.teams$awayTeam)
  ht <- extractTeam(.teams$homeTeam)
  
  at <- addOpponent(at, ht)
  ht <- addOpponent(ht, at)
  
  bind_rows(at,ht) %>% 
    return()

}

# para cada conjunto de jogos dentre de uma semana
# processa o jogo
extractWeekGames <- function(.weekgames){
  .weekgames %>% 
    map_df(extractGame)
}

# para todas as semanas
wrank <- matchups %>% 
  map_df(
    extractWeekGames,
    .id="week"
  )

# para a geracao no confronto direto
# por semana computa o h2h balance time a time
h2h.weekly <-  wrank %>% 
  select(week, id, team, outcome, op.out, op.team, op.id) %>% 
  mutate( h2h.balance = (outcome=="win") - (op.out=="win") )

# entao monta uma tabela acumulando semana a semana
# exemplo, na semana 3, na verdade tem a soma do h2h da semana 1, 2 e 3
h2h.table <-  1:curr.week %>% # quantas semanas?
  map(~seq(1,.x)) %>% # gera uma lista de semanas (1, 1:2, 1:3, 1:4, ...)
  map_df(function(.weeks, .h2hw){
    .h2hw %>% 
      filter(week %in% .weeks) %>% # vai acumulando 
      group_by(id, team, op.id, op.team) %>% 
      summarise( balance = sum(h2h.balance)) %>% 
      ungroup() %>% 
      mutate(week = max(.weeks)) %>% 
      return()
  }, 
  .h2hw = h2h.weekly)

# computa time time, semana a semana o 
# numero de vitorias, terrotas, pontos pro e contra
wrank <- wrank %>% 
  group_by(team) %>% 
  arrange(team,week) %>% 
  mutate( 
    wins = cumsum(win),
    losses = cumsum(loss),
    pts.pro = cumsum(pts),
    pts.ag  = cumsum(pts.ctr)
  ) %>% 
  ungroup() %>% 
  filter(week <= curr.week)

# agrupa, semana a semana os grupos de time com mesmo
# numero de vitorias e derrotas
finalrank <- wrank %>% 
  mutate( .week = week ) %>% # precisa aninhar a semana para passar para a h2h.table dentro do grupo
  group_by(week, wins, losses) %>% 
  nest() %>% 
  mutate(
    data = map(data, function(.x, .h2ht){
      
      # descobre a semana do grupo
      sel.week <- unique(.x$.week)
      
      # filtra qual eh a h2h table que importa
      wh2h <- filter(.h2ht, week==sel.week)
      
      # gera as comubinações entre todos os oponentes do grupo
      expand.grid(id=.x$id, op.id=.x$id) %>% 
        # junta com o balanco h2h
        inner_join(wh2h, by = c("id", "op.id")) %>% 
        group_by(id, team) %>% 
        # calcula o balanco entre os times do grupo
        summarise(h2h.balance=sum(balance)) %>% 
        ungroup() %>% 
        # recompoem com dados do resultado da semana
        right_join(.x, by = c("id", "team")) %>% 
        # zera o balanco se houver NA
        mutate( h2h.balance = ifelse(is.na(h2h.balance),0,h2h.balance) ) %>% 
        select(-.week) %>% 
        return()
    },
    .h2ht=h2h.table)
  ) %>% 
  unnest(data) %>% 
  arrange(week, desc(wins), desc(h2h.balance), desc(pts.pro), pts.ag) %>% 
  mutate( wrank = rep(1:10,curr.week) ) %>% 
  select(-op.id, -op.team, -op.out)
```



```{r weekrank, eval=FALSE}

## League Standing

#  width='50' height='50' style='{ width: 50px; height: 50px; }'

finalrank %>% 
  filter(week==curr.week) %>% 
  arrange(wrank) %>% 
  select(wrank, logoUrl , team, wins, losses, pts.pro, pts.ag) %>%
  mutate( logoUrl = str_c("<img src='", logoUrl, "' style='width:50px;height:50px;' />") ) %>% 
  set_names("position", "flag", "team","wins", "losses", "pts.for","pts.against") %>% 
  kable() %>%
  kable_styling(font_size = 7)

```



## League Standings Evolution

```{r leagueStanding}
finalrank %>% 
  mutate(wlt=paste0(wins, "-", losses)) %>% 
  ggplot(aes(x=week, y=reorder(wrank,-wrank), group=team)) +
  geom_line(aes(color=team), size=2) +
  geom_image(aes(image=logoUrl), size=.04) +
  geom_hline(yintercept = 6.5, linetype="dashed", size=1, color="darkgrey") +
  geom_text(aes(label=wlt), size=2.5, color="black", nudge_y = -.33) +
  geom_text(x=4.4, y=6.65, label="playoff clinch", size=3, color="darkgrey") +
  ylab("rank") +
  theme_void()
```

## Weekly Points

```{r weeklyPoints}

finalrank %>%
  ggplot(aes(x=week, y=pts, group=team)) +
  geom_line(aes(color=team), size=1.7) +
  geom_image(aes(image=logoUrl)) +
  # ggtitle("Pontuação dos Times", "por semana") +
  ylab("points") +
  theme_minimal()

```


## Season Points

```{r seasonPoints}

finalrank %>% 
  ggplot(aes(x=week, y=pts.pro, group=team)) +
  geom_line(aes(color=team), size=1.5) +
  geom_image(aes(image=logoUrl), size=.03) +
  # ggtitle("Pontuação Acumulada dos Times", "semana à semana") +
  ylab("points") +
  theme_minimal()
```

## Best League Players of Week

```{r bestTeamPlayers}

# so para pegar o time da liga do jogador
player.team <- readRDS(glue("./data/week{curr.week}_players_projections.rds")) %>% 
  select(id, nfl_id, fantasy.team)

# estatisticas do jogador
player.points <- readRDS("./data/players_points.rds") %>% 
  filter(week==curr.week)

# junta
players <- inner_join(player.team, player.points, by = c("id", "nfl_id")) %>% 
  select(-rosterSlots)  

buildTeam <- function(.players){
  # starters - slots unicos
  st01 <- tibble(
    pos=c("QB","RB","WR","TE","K","DEF"),
    qtd=c(1,2,2,1,1,1)
  ) %>% 
    split(1:nrow(.)) %>% 
    map_df(function(.x, .p){
      .p %>% 
        filter(position==.x$pos) %>%
        top_n(.x$qtd, points)
    }, .p=.players)
  
  # starters - slot versatil
  starters <- .players %>% 
    filter(position %in% c("WR","RB")) %>% 
    anti_join(st01, by = c("id", "nfl_id")) %>% 
    top_n(1, points) %>% 
    bind_rows(st01,.)
  
  ideal_team <- starters %>% 
    mutate(fullName = paste0(firstName, " ", lastName)) %>% 
    select(position, fullName, team, points, fantasy.team)
}

# filtra melhores players com time
players %>% 
  filter(fantasy.team!="*FreeAgent") %>% 
  buildTeam() %>% 
  kable()
  
```


## Best Free Agents of Week

```{r bestFAPlayers}

# filtra melhores players com time
players %>% 
  filter(fantasy.team=="*FreeAgent") %>% 
  buildTeam() %>% 
  kable()

```


## Twittersphere

{{< tweet 1186025478794039296 >}}
