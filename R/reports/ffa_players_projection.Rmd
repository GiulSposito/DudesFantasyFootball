---
title: "It's Football, dudes - Fantasy League"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
# library(ffanalytics)
```

```{r loaddata, cache=FALSE}

# pega projecoes cria algumas colunas auxiliares
projections <- readRDS("../../data/week10_players_projections.rds") %>% 
  mutate( full_name = paste0(first_name, " ", last_name),
          fantasy.team = as.factor(fantasy.team) ) %>%
  group_by( id ) %>% 
  mutate( r_pos = max(ceiling, points) ) %>% # posicao do label
  ungroup() %>% 
  filter( !(team %in% c("FA","FA*")) ) # havia lixo em alguns


readRDS("../../data/players_points.rds") %>%
  rename( pts = points ) %>% 
  select( id, week, pts) %>% 
  group_by( id ) %>% 
  mutate( pts.mean = median(pts, na.rm = T),
          pts.max = max(pts, na.rm=T),
          pts.min = min(pts, na.rm = T)) %>% 
  ungroup() %>% 
  right_join(projections, by = "id") -> projections
  
```

QB {data-navmenu="ffanalytics"}
========================

```{r qb}

plotProjections <- function(.proj, .pos, .title, .subtitle, .slice=32) {
  require(magrittr)
  proj_data <- .proj %>% 
    select(id, position, pos_rank ) %>% 
    filter(position==.pos) %>% 
    distinct() %>% 
    top_n(-.slice, pos_rank) %>% 
    select(id)
  
  proj_data %>% 
    inner_join(.proj, by="id") -> proj_data
  
  nu_y <- max(proj_data$ceiling, na.rm = T) / 18
  
  proj_data %>% 
    ggplot(aes(group=fantasy.team)) +
    geom_pointrange(aes(x=reorder(pos_rank,desc(pos_rank)),
                    y=points, 
                    ymin=floor, 
                    ymax=ceiling, 
                    color=fantasy.team), size=1) +
    # geom_point(aes(x=reorder(pos_rank,desc(pos_rank)),
    #                y=pts), color="black", alpha=.05) +
    geom_point(aes(x=reorder(pos_rank,desc(pos_rank)),
                   y = pts.mean), color="black" ) +
    geom_text(aes(x=reorder(pos_rank,desc(pos_rank)), 
              y=r_pos, 
              color=fantasy.team, 
              label=full_name), nudge_y = nu_y, nudge_x = 0.0, size=3) +
    scale_colour_manual(values = c("grey",  "#e31a1c", "#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#fdbf6f", "#ff7f00")) +
    theme_classic() + xlab("Rank") + ylab("Points") +
    theme( panel.grid.major.x=element_line(colour="#EEEEEE") ) +
    scale_x_discrete(breaks = seq(1,32,4) ) +
    ggtitle(.title,.subtitle) +
    coord_flip() -> g
  
  g %>% 
    ggplotly() %>% 
    return()
  
}

plotProjections(projections, "QB", "Quaterbacks", "week 9", 20)

```

WR {data-navmenu="ffanalytics"}
========================

```{r wr}

plotProjections(projections, "WR", "Wide Receivers", "week 9",50)

```

RB {data-navmenu="ffanalytics"}
========================

```{r rb}

plotProjections(projections, "RB", "Running Backs", "week 9",50)

```

TE {data-navmenu="ffanalytics"}
========================

```{r te}

plotProjections(projections, "TE", "Tight Ends", "week 9",20)

```


K {data-navmenu="ffanalytics"}
========================

```{r k}

plotProjections(projections, "K", "Kickers", "week 9",20)

```


DEF {data-navmenu="ffanalytics"}
========================

```{r def}

plotProjections(projections, "DST", "Defenses", "week 9",32)

```


```{r points}
players.points <- readRDS("../../data/players_points.rds")
```

